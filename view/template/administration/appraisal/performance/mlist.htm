<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title></title>
    <meta http-equiv="Content-Type" content="text/html; charset=gb2312" />
    <script src="js/extui/boot.js" type="text/javascript"></script>
</head>
<body>
<style type="text/css">
    html, body{
        margin:0;padding:0;border:0;width:100%;height:100%;overflow:hidden;
    }    
	.actionLinks
    {
        margin-left:30px;
        display:none;
		background-image:url(../../../../images/ic_middle.gif);
    }
    .mini-grid-row-hover .actionLinks
    {
        display:inline;
    }
	.txtmenu{
		width:40px;
		height:40px;
background-image:url(../../../../images/ic_middle.gif);
		}

    </style>
<body>
<div class="mini-toolbar" style="border-bottom:0; margin:10px; margin-bottom:0px;">
 <form id="excelForm"  action="?model=administration_appraisal_performance_list&action=exportExcel" method="post" target="excelIFrame">
        <input type="hidden" name="columns" id="columns" />
            <table style="width:100%;">
                <tr>
                    <td style="width:90%; vertical-align:middle;">
                    部门: <input name="deptId" id="deptId" type="text" class="mini-treeselect" style="width:160px;"   valueFromSelect="false" textField="text" valueField="id" parentField="pid" emptyText="请选择部门" onvaluechanged="search(1)" multiSelect="true"   allowInput="false"  url="?model=administration_appraisal_performance_list&action=deptData" checkRecursive="false" 
        showFolderCheckBox="true"  expandOnLoad="true" showClose="true" oncloseclick="onCloseClick"/>
                    年份：<input   class="mini-combobox" url="?model=administration_appraisal_performance_item&action=tplYearData" emptyText="请选择年份" name="tplYear" id="tplYear" style="width:60px;"  onvaluechanged="search(1)"/>
                    周期：<input   url="?model=administration_appraisal_performance_item&action=tplTypeData" class="mini-combobox" emptyText="请选择模板类型"  name="tplStyle" id="tplStyle"  style="width:80px;" required="true" onvaluechanged="search(1)"/>
                    状态：<input  data="statusData" class="mini-combobox" emptyText="请选择状态"  name="tplStatus" id="tplStatus"  style="width:80px;"  onvaluechanged="search(1)"/>
                    关键字：<input id="wordkey" class="mini-buttonedit searchbox" style=" width:200px;" showClose="true"  onbuttonclick="onKeyEnter" selectOnFocus="true" emptyText="请输入搜索"  onenter="onKeyEnter" oncloseclick="onCloseClick"/>&nbsp;
                    {sort}
                         <!-- <a class="mini-button" iconCls="icon-search" onclick="search()">查&nbsp;询&nbsp;&nbsp;</a>-->
                    </td>
                    <td style="white-space:nowrap;"><!--<a class="mini-button" iconCls="icon-sort" onclick="deptSort()">生成排名</a>-->
                       {import}
                       <a class="mini-button" iconCls="icon-download"  onclick="ExportExcel()">导出</a>
                       <a class="mini-button" iconCls="icon-download"  onclick="ToEmail()">邮办</a>
                    </td>
                </tr>
            </table>
      
    </form>                    
        </div>
    <div class="mini-fit" style=" margin:10px; margin-top:0px;">
        <div id="griddata" class="mini-datagrid" style="width:100%;height:100%" allowResize="true" allowAlternating="true"
        url="?model=administration_appraisal_performance_list&action=mlistData"  idField="id" multiSelect="true" allowUnselect="false"       
         contextMenu="#gridMenu"  pagesize="20" onshowrowdetail="onShowRowDetail" frozenStartColumn="0" frozenEndColumn="4" showColumnsMenu="true">
        <div property="columns">
            <div type="indexcolumn"></div>
            <div field="sortRank"  name="sortRank" width="0" headerAlign="center" allowSort="true">临时排名</div>
            <div field="userNo" width="60" headerAlign="center" allowSort="true">员工号</div>
            <div field="userName" width="60" headerAlign="center" allowSort="true">被考核人</div>
            <div field="deptNameNow" width="80" headerAlign="center" allowSort="true">当前部门</div>
            <div field="deptName" width="80" headerAlign="center" allowSort="true">考核时部门</div>
            <div field="jobName" width="80" headerAlign="center" allowSort="true">职位</div>
            <div field="comeInDate" width="60" headerAlign="center" allowSort="true">入职日期</div>
            <div field="ReguDate" width="60" headerAlign="center" allowSort="true">转正日期</div>
            <div field="name" width="170" headerAlign="center" allowSort="true" renderer="onRenderer">模板名称</div>    
            <<div field="years" width="80" headerAlign="center" allowSort="true">年份</div>
            <div field="quarter" width="60" headerAlign="center" allowSort="true">考核周期</div>
            <div field="inFlag" width="70" headerAlign="center" allowSort="true" renderer="onStatus">状态</div>    
            <div field="count_my_fraction" width="60" headerAlign="center" allowSort="true">自评总分</div>
            <div field="pevFraction" width="60" headerAlign="center" allowSort="true">评价总分</div>
          <div type="expandcolumn" width="45" style="color:#F00">评价人</div>
          <div field="assessName" width="60" headerAlign="center" allowSort="true">考核人</div>
          <div field="assess_status" width="60" headerAlign="center" allowSort="true" renderer="onAsStatus">考核状态</div>
          <div field="count_assess_fraction" width="60" headerAlign="center" allowSort="true">考核总分</div>
          <div field="assess_date" width="60" headerAlign="center" allowSort="true">考核时间</div>
          <div field="auditName" width="60" headerAlign="center" allowSort="true">审核人</div>
          <div field="audit_status" width="60" headerAlign="center" allowSort="true" renderer="onAuditStatus">审核状态</div>
          <div field="count_audit_fraction" width="60" headerAlign="center" allowSort="true">审核总分</div>
          <div field="audit_date" width="60" headerAlign="center" allowSort="true">审核时间</div>
          <div field="finalScore" width="40" headerAlign="center" allowSort="true">总分</div>
          <div field="deptRank" width="40" headerAlign="center" allowSort="true">排名</div>
          <div field="deptRankPer" width="95" headerAlign="center"  align="right" allowSort="true">排名比例(前)</div>
        </div>
    </div>
    </div>
  
<div id="winBegine" class="mini-window" title="排名" style="width:500px; text-align:center" 
    showMaxButton="false" showFooter="true" showModal="true" allowResize="false" allowDrag="true">
<div id="chartContainer" class="form" >
<table border="0" cellspacing="0" cellpadding="0" class="tables" style="width:100%;height:auto">
  <tr>
    <td  class="form_text_left_con">所属部门：</td>
    <td><input name="begineDeptId" id="begineDeptId" type="text" class="mini-treeselect" style="width:160px;" multiSelect="true"  valueFromSelect="false" textField="text" valueField="id" parentField="pid" emptyText="请选择部门" allowInput="false"  required="true" url="?model=administration_appraisal_performance_item&action=tplDeptData" showFolderCheckBox="true"  expandOnLoad="true" showClose="true" oncloseclick="onCloseClick"/></td>
    </tr>
  <tr>
    <td  class="form_text_left_con">考核年份：</td>
    <td><input   class="mini-combobox" url="?model=administration_appraisal_performance_item&action=tplYearData" emptyText="请选择年份" name="begineYear" id="begineYear" style="width:60px;" required="true" /></td>
      </tr>
  <tr>
    <td  class="form_text_left_con">考核周期：</td>
    <td><input   url="?model=administration_appraisal_performance_item&action=tplTypeData" class="mini-combobox" emptyText="请选择模板类型"  name="begineStyle" id="begineStyle"  style="width:80px;" required="true"/></td>
    </tr>
</table>
</div>
 	<div property="footer" style="text-align:center;padding:5px;"> 
    <a class="mini-button" style="width:60px;" onclick="submitWinBegine()">提交</a> 
       <span style="display:inline-block;width:25px;"></span> 
       <a class="mini-button" style="width:60px;" onclick="hideWinBegine()">取消</a> 
	</div>
</div>
 <div id="detailSub" style="display:none;">
         <div id="gridSub" class="mini-datagrid" style="width:auto;height:auto"  dField="id" showFooter="false"  allowSortColumn="false" multiSelect="true"  url="?model=administration_appraisal_performance_list&action=getEvalerData">
    <div property="columns">
             <div type="indexcolumn" headerAlign="center" width="30"></div>
             <div field="evalName" width="100"  headerAlign="center" >评 价 人
             </div> 
            <div field="evalDate" width="100"  headerAlign="center" currencyUnit="%">评价时间
             </div>
            <div field="flag" width="70"  headerAlign="center" renderer="onEvalStatus" >状态
             </div>
            <div field="count_fraction" width="100%"  headerAlign="center" allowCellValid="true">评价分数
            </div>             
    </div>
</div>
</div>


     <ul id="gridMenu" class="mini-contextmenu" style="width:160px;" onbeforeopen="onBeforeOpen">
       <li name="details" iconCls="icon-node" onclick="onExIn">查看</li>
       <li name="addEval" iconCls="icon-add" onclick="onAddEval">添加评价人</li>  
       <li name="editEval" iconCls="icon-edit" onclick="onEditEval">修改评价人</li>
       <li name="editAll" iconCls="icon-edit" onclick="onEdit">修改</li> 
       <li name="close" iconCls="icon-remove" onclick="onClose">关闭</li>                
    </ul>
    
    

<script type="text/javascript">
  var statusData=[{ "id": "", "text": "所有" },{ "id": "1", "text": "未开始" },{ "id": "2", "text": "自评中" },{ "id": "3", "text": "评价中" },{ "id": "4", "text": "考核中" },{ "id": "5", "text": "审核中" },{ "id": "6", "text": "发布结果中" },{ "id": "7", "text": "完成" },{ "id": "10", "text": "关闭" }];	
		var winAddTpl;
		mini.parse();
        var grid = mini.get("griddata");
		
        grid.load();
		 grid.on("drawcell", function (e) {
            var record = e.record,
        column = e.column,
        field = e.field,
        value = e.value;

            //给年龄，增加"岁"字符串
            if (field == "deptRankPer"&&value) {
                e.cellHtml = value + "%";
            }
         
        });
		var grid_sub = mini.get("gridSub");
		grid.hideColumn("sortRank");
        var detailSub = document.getElementById("detailSub");
		function onShowRowDetail(e) {
            var grid = e.sender;
            var row = e.record;
            var td = grid.getRowDetailCellEl(row);
            td.appendChild(detailSub);
            detailSub.style.display = "block";
            grid_sub.load({ keyId: row.id });
        }
		 function search(flag) {
			 if(flag==2){
			    grid.setColumnWidth("sortRank",60);
				grid.showColumn("sortRank");
			 }else{
				grid.setColumnWidth("sortRank",0);
				grid.hideColumn("sortRank");
			 }
            var deptId = mini.get("deptId").getValue();
			var tplYear = mini.get("tplYear").getValue();
			var tplStyle = mini.get("tplStyle").getValue();
			var tplStatus = mini.get("tplStatus").getValue();
			var wordkey = mini.get("wordkey").getValue();
            grid.load({ deptId: deptId,tplYear:tplYear,tplStyle:tplStyle,tplStatus:tplStatus,wordkey:wordkey,flag:flag });
        }
        function onKeyEnter(e) {
            search(1);
        }

		function onExIn(){
		   var row = grid.getSelected();
            if (row) {
			  winAddTpl=mini.open({
                    url: "?model=administration_appraisal_performance_list&action=perExIn&keyId="+row.id+"&tplId="+row.tpl_id,
                    title: "查看考核", width:'75%', height:'75%',allowResize:true,showMaxButton:true,
					ondestroy: function (action) {
                    	grid.reload();
                	}
                });
			} else {
                alert("请选中一条记录");
            }
		   }
		   
		 function onAddEval(){
		   var row = grid.getSelected();
            if (row) {
			       winAddTpl=mini.open({
                    url: "?model=administration_appraisal_performance_list&action=addEval&keyId="+row.id+"&tplId="+row.tpl_id,
                    title: "添加评价人", width: 600, height: 350,allowResize:true,showMaxButton:true,
					ondestroy: function (action) {
                    	grid.reload();
                	}
                });
			} else {
                alert("请选中一条记录");
            }
		   }    
		function onEditEval(){
			var row = grid.getSelected();
            if (row) {
			  winAddTpl=mini.open({
                    url: "?model=administration_appraisal_performance_list&action=editEval&keyId="+row.id+"&tplId="+row.tpl_id,
                    title: "添加评价人", width: 600, height: 350,allowResize:true,showMaxButton:true,
					ondestroy: function (action) {
                    	grid.reload();
                	}
                });
			} else {
                alert("请选中一条记录");
            } 
		}
		
	function onEdit(){
		var row = grid.getSelected();
		if (row) {
		  winAddTpl=mini.open({
				url: "?model=administration_appraisal_performance_list&action=editManager&keyId="+row.id+"&tplId="+row.tpl_id,
				title: "编辑", width: 600, height: 350,allowResize:true,showMaxButton:true,
				ondestroy: function (action) {
					grid.reload();
				}
			});
		} else {
			alert("请选中一条记录");
		}
		
	}	
	function ImportExcel(){
		winAddTpl=mini.open({
				url: "?model=administration_appraisal_performance_list&action=importExcel",
				title: "编辑", width: 600, height: 350,allowResize:true,showMaxButton:true,
				ondestroy: function (action) {
					grid.reload();
				}
			});
	}
	function ToEmail() {
            var deptId = mini.get("deptId").getValue();
			var tplYear = mini.get("tplYear").getValue();
			var tplStyle = mini.get("tplStyle").getValue();
			var tplStatus = mini.get("tplStatus").getValue();
			var wordkey = mini.get("wordkey").getValue();
			if(tplYear&&tplStyle&&tplStatus){
				if(confirm('您确定邮件提醒用户操作吗？')) {
					$.ajax({
						url: "?model=administration_appraisal_performance_list&action=toEmail",
						type: "post",
						data: {deptId:deptId,tplYear:tplYear,tplStatus:tplStatus,tplStyle:tplStyle,wordkey:wordkey},
						success: function (text) {
							if(text==2){
								alert('发送成功！');
								grid.reload();
							}else{
								alert('发送失败！');	
							}
						}
					});
			   }
		   }else{
				alert("请选择相关条件!");   
			   
		   }
     }
		
function onBeforeOpen(e) {
    var menu = e.sender;
    var row = grid.getSelected();
    var rowIndex = grid.indexOf(row);            
	if (!row) {
        e.cancel = true;
        //阻止浏览器默认右键菜单
        e.htmlEvent.preventDefault();
        return;
    }
	var details = mini.getbyName("details", menu);
	details.show();
	var addEval = mini.getbyName("addEval", menu);
	var editEval = mini.getbyName("editEval", menu);
	var editAll = mini.getbyName("editAll", menu);
	addEval.show();
	editEval.hide();
	if(row.isEval==2){
	   editEval.show();
	   addEval.hide();
	}		
	if(row.inFlag!=1){
	  addEval.hide();
	  editEval.hide();
	}
	if(row.inFlag>6){
	    editAll.hide();
	}else{
		editAll.show();
	}
}
		function adds(o) {
            $("#"+o.id).click(function (e) {
		    var row = grid.getSelected();
            var rowbox = grid.getRowBox(row);
			var menu = mini.get("gridMenu");
			menu.showAtPos(e.pageX,rowbox.bottom);
			var details = mini.getbyName("details", menu);
	        details.show();
			var addEval = mini.getbyName("addEval", menu);
			var editEval = mini.getbyName("editEval", menu);
			var editAll = mini.getbyName("editAll", menu);
			addEval.show();
			editEval.hide();
			if(row.isEval==2){
			   editEval.show();
			   addEval.hide();
			}		
			if(row.inFlag!=1){
			  addEval.hide();
			  editEval.hide();
			}
			if(row.inFlag>6){
				editAll.hide();
			}else{
				editAll.show();
			}
			   
		});
		};
  
  function onCloseClick(e){
	  var t = mini.get(e.sender.id);
            t.setValue("");
            t.setText("");
	  }  
function onAsStatus(e){
	 var val = e.value;
	 var str;
	 if(e.record.assess_userid){
	 if(val==1&&e.record.inFlag>3){
	  str='已考核';	 
	 }else{
	  str='待考核';	 
	 }
	 }
	return str;
}
function onAuditStatus(e){
	 var val = e.value;
	 var str;
	 if(val==1&&e.record.inFlag>5){
	  str='已审核';	 
	 }else{
	  str='待审核';	 
	 }
	return str;
}

function onEvalStatus(e){
	 var val = e.value;
	if(val==2){
	  str='已评价';	 
	 }else{
	  str='待评价';	 
	 }
	 return str;
}

        function onRenderer(e) {
            var s = e.value;
			d=e.sender;
		    s += '<span class="btn-menu-group" id="menu-'+e.rowIndex+'" onclick="adds(this)" ><a class="btn" href="#"><span class="icon-optionss"></span><span class="caret"></span></a></span>';
            return s;
        }
		
		function onStatus(e){
			 var val = e.value;
			 var isEvalValue=e.record.isEval;
			 var isAssValue=e.record.isAss;
			 var str;
			 if(val==1){
			  str='未开始';	 
		     }else if(val==2){
				if(isAssValue==1){
					str='自评中';	
				}else if(isEvalValue==2&&isAssValue!=1){
					str='评价中';	
				}else{
					str='考核中';
				} 
		     }else if(val==3){
			  str='评价中';	 
		     }else if(val==4){
			  str='考核中';	 
		     }else if(val==5){
			  str='审核中';	 
		     }else if(val==6){
			  str='发布结果中';	 
		      }else if(val==7){
				 if(e.record.isAsug==1){
				  str='反馈意见';
				 }else{
				   str='完成';	 
				}
			  	 
		     }else if(val==10){
			  str='关闭';	 
		     }
            return str;
		}	  
function deptSort(){
		 var win = mini.get("winBegine");
        win.show();
	}
	function hideWinBegine(){
		 var win = mini.get("winBegine");
        win.hide();
	}	
	function submitWinBegine() {
            var form = new mini.Form("#winBegine");
			form.validate();
            if (form.isValid() == false) return false;
			var formData = form.getData();
            var infoData = mini.encode(formData);
            $.ajax({
                url: "?model=administration_appraisal_performance_list&action=begineSort",
                type: "post",
                data: { infoData:infoData},
                success: function (text) {
					if(text==2){
						alert('操作成功！');
						hideWinBegine();
					}else{
					    alert('操作失败！');	
					}
                }
            });
        }
		function valueReplace(v){ 
		v=v.toString().replace(new RegExp('(["\"])', 'g'),"\\\""); 
		return v; 
		} 
//var eValue = encodeURI($.trim(valueReplace(e.value))) 	
	function ExportExcel()
	{
		if (confirm('您确定要导出当前数据吗？')) 
		{
			var deptId = mini.get("deptId").getValue();
			var tplYear = mini.get("tplYear").getValue();
			var tplStyle = mini.get("tplStyle").getValue();
			var tplStatus = mini.get("tplStatus").getValue();
			var wordkey = mini.get("wordkey").getValue();
			 var columns = grid.getBottomColumns();
            
            function getColumns(columns) {
                columns = columns.clone();
                for (var i = columns.length - 1; i >= 0; i--) {
                    var column = columns[i];
                    if (!column.field) {
                        columns.removeAt(i);
                    } else {
                        var c = { header: column.header, field: column.field };
                        columns[i] = c;
                    }
                }
                return columns;
            }
			
            var columns = getColumns(columns);
            var columnsJson = mini.encode(columns); 
			//$("#columns").val(columnsJson)
			document.getElementById("columns").value =columnsJson;//$.trim(valueReplace(columnsJson)) ;
            var excelForm = document.getElementById("excelForm");
            //excelForm.submit();   
		   /*
			$.ajax({
                url: "?model=administration_appraisal_performance_list&action=exportExcel",
                type: "POST",
                data: { deptId:deptId,tplYear:tplYear,tplStyle:tplStyle,tplStatus:tplStatus,wordkey:wordkey,columns:columnsJson},
                success: function (text) {
					
					alert(text);
					if(text==2){
						alert('操作成功！');
						hideWinBegine();
					}else{
					    alert('操作失败！');	
					}
					
                }
            });  
			*/
			
			location.href = '?model=administration_appraisal_performance_list&action=exportExcel&deptId=' + deptId + '&tplYear=' + tplYear + '&tplStyle=' + tplStyle + '&tplStatus=' + tplStatus + '&wordkey=' + wordkey;
		
		}
	} 
	function CloseOpen() {
		 winAddTpl.destroy();
		 grid.load();          
		//window.parent.grid.load();  
}


function onClose() {
           var row = grid.getSelected();
		   if(confirm('您确定关闭当前数据吗？')&&row) {
            $.ajax({
                url: "?model=administration_appraisal_performance_list&action=optionStatus",
                type: "post",
                data: {inFlag:10,keyId:row.id},
                success: function (text) {
					if(text==2){
						alert('操作成功！');
						grid.reload();
					}else{
					    alert('操作失败！');	
					}
                }
            });
        }
}
	 
  </script>
</body>
</html>