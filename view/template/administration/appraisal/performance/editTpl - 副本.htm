<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=GB2312" />
<script type="text/javascript" src="js/extui/boot.js"></script>
<title></title>
</head>
<style type="text/css">
    body{
        margin:0px;padding:0px;border:0px;width:100%;height:100%;overflow:hidden;
    }
    </style>
<body>
<div class="mini-fit" id="form" >
<fieldset>
<legend  class="legend" onclick="showAndHideDiv('asImg','asInfo')">模板设置
	<img id="asImg" src="images/icon/info_up.gif"><input name="keyId"  id="keyId" type="text" value="{keyId}"  class="mini-hidden"/>
</legend>
    <table id="asInfo" border="0" cellpadding="0" cellspacing="0" align="center" class="tables" style="width:100%;height:auto">
      <tr>
        <td  class="form_text_left_con">模板名称：</td>
        <td class="form_text_right_con"><input name="tplName"  id="tplName" type="text" value="{tplName}"  class="mini-textbox"  style="width:280px;" required="true"/>
        </td>
        <td class="form_text_left_con">归属部门：</td>
        <td class="form_text_right_con"><input name="deptId" id="deptId" type="text" value="{deptId}" class="mini-treeselect" style="width:280px;" multiSelect="false"  valueFromSelect="false" textField="text" valueField="id" parentField="pid" emptyText="请选择归属部门"  allowInput="false"  required="true" url="?model=administration_appraisal_performance_item&action=tplDeptData"/></td>
      </tr>
       <tr>
        <td  class="form_text_left_con">模板年份 ：</td>
        <td class="form_text_right_con"><input   class="mini-combobox" value="{tplYear}" url="?model=administration_appraisal_performance_item&action=tplYearData" emptyText="请选择年份" name="tplYear" id="tplYear" style="width:280px;" required="true" /></td>
        <td class="form_text_left_con">模板类型：</td>
        <td class="form_text_right_con"><input   url="?model=administration_appraisal_performance_item&action=tplTypeData" class="mini-combobox" emptyText="请选择模板类型"  name="tplStyle" id="tplStyle"  style="width:280px;" value="{tplStyle}" required="true" /></td>
      </tr>
      <tr>
        <td  class="form_text_left_con">考 核 人：</td>
        <td class="form_text_right_con">
        <div class="mini-autocomplete" style="width:280px;" id="assess" name="assess"  value="{assess}" text="{assess}" valueFromSelect="true"  popupWidth="280" required="true" textField="text" valueField="id" url="?model=administration_appraisal_performance_item&action=userData" showNullItem="false">     
        <div property="columns">
            <div header="部门" field="deptName"></div>
            <div header="姓名" field="text"></div>
        </div>
    </div>
    </td>
        <td class="form_text_left_con">审 核 人：</td>
        <td class="form_text_right_con"><div class="mini-autocomplete" id="audit" name="audit" value="{audit}"   text="中国" valueFromSelect="true" required="true" style="width:280px;"  popupWidth="280" textField="text" valueField="id" 
        url="?model=administration_appraisal_performance_item&action=userData" showNullItem="false" >     
        <div property="columns">
            <div header="部门" field="deptName"></div>
            <div header="姓名" field="text"></div>
        </div>
    </div></td>
      </tr
 >
      <tr>
        <td  class="form_text_left_con">归属类型：</td>
        <td class="form_text_right_con"><div  name='userType' id='userType'   repeatItems="1" class="mini-radiobuttonlist" required="true"   value="{userType}"  data="userTypeData" textField="text" valueField="id" ></div>
                </td>
        <td class="form_text_left_con" id="userStrId">人 员：</td>
        <td class="form_text_right_con"> <input id="userStr" name="userStr" class="mini-buttonedit searchbox" style=" width:280px;" showClose="true"  onbuttonclick="onEnterClick" selectOnFocus="true" emptyText="请选择-->"  value="{userStr}" text="{userStr}" required="true" allowInput="false"  onenter="onEnterClick" oncloseclick="onCloseClick"/></td>
      </tr>
      <tr>
        <td class="form_text_left_con">模板类型：</td>
        <td class="form_text_right_con"><div  name="tplStyleFlag" id="tplStyleFlag"  repeatItems="1" class="mini-radiobuttonlist" required="true"  value="{tplStyleFlag}" data="tplTypeData" textField="text" valueField="id" ></div></td>
        <td  class="form_text_left_con">备    注：</td>
        <td  class="form_text_right_con"><textarea name="remark" id="remark"  class="mini-textarea" emptyText="请输入备注" style="width:280px;">{remark}</textarea></td>
      </tr>
    </table>
 </fieldset>   
<fieldset>
<legend  class="legend">录入模板类型设置
	<img id="linkmanImg" src="images/icon/info_up.gif">
</legend>
<table id="asInfo" border="0" cellpadding="0" cellspacing="0" align="center" class="tables" style="width:98%;height:auto">
      <tr>
      <td width="50%" valign="top">
<div id="grid1" class="mini-datagrid" style="width:100%;height:auto"  dField="id"  showFooter="false"  allowSortColumn="false" multiSelect="true" url="?model=administration_appraisal_performance_item&action=getGridProjectNameData&keyId={keyId}">
    <div property="columns">
             <div type="removecolumn" headerAlign="center" width="30"></div>
             <div type="indexcolumn" headerAlign="center" width="30"></div>
             <div field="projectName" width="100%"   headerAlign="center" >考核项名称
                <input property="editor" class="mini-textbox" style="width:100%;" onvalidation="isrequired" minHeight="80"/>
            </div>            
    </div>
</div>
</td><td width="50%" valign="top">
<div id="grid2" class="mini-datagrid" style="width:100%;height:auto"  dField="id" showFooter="false"  allowSortColumn="false" multiSelect="true" url="?model=administration_appraisal_performance_item&action=getGridColumnsNameData&keyId={keyId}">
    <div property="columns">
             <div type="removecolumn" headerAlign="center" width="30"></div>
             <div type="indexcolumn" headerAlign="center" width="30"></div>
             <div field="columnsName" width="100%"  headerAlign="center" >考核尺度名称
                <input property="editor" class="mini-textbox" style="width:100%;" onvalidation="isrequired" minHeight="80"/>
            </div>            
    </div>
</div>
</td>
      </tr>
    </table>
</fieldset>
</div>
<div class="mini-toolbar" style="text-align:center;margin:0px; border-bottom:0px; border-left:0px; border-right:0px;" > <a class="mini-button" style="width:60px;" onclick="submitForm()">确定</a> <span style="display:inline-block;width:25px;"></span> <a class="mini-button" style="width:60px;" onclick="onCancel()">取消</a></div>
<script type="text/javascript"> 
 var userTypeData=[{ "id": "1", "text": "人 员" },{ "id": "2", "text": "职 位" }];
 var tplTypeData=[{ "id": "1", "text": "录入型模板" },{ "id": "2", "text": "HTML型模板" },{ "id": "3", "text": "EXCEL导入型模板" }];
          mini.parse();
		   /*
		   function beforenodeselect(e) {
            //禁止选中父节点
            if (e.isLeaf == false) e.cancel = true;
           }
           */
		function onEnterClick(){
			userType=mini.get('userType').getValue();
			if(userType==1){
				url="?model=deptuser_user_user&action=selectuser&mode=check&showDialog=1&isOnlyCurDept=false&deptIds=&formCode=stampConfig";
				revalue=showModalDialog(url,'dialogWidth:900px;dialogHeight:550px;');
				var userStr = mini.get("userStr");
				if(revalue){
				  userStr.setValue(revalue.val)
				  userStr.setText(revalue.text)	
				}
			}else if(userType==2){
			   mini.open({
					url:"?model=deptuser_user_user&action=selectuser&mode=check&showDialog=1&isOnlyCurDept=false&deptIds=&formCode=stampConfig",    
					title: "选择人员",
					width: 700,
					height: 530,
					ondestroy: function (action) {
						if (action == "ok") {
							var iframe = this.getIFrameEl();
							var data = iframe.contentWindow.GetData();
							data = mini.clone(data);
							btnEdit.setValue(data.id);
							btnEdit.setText(data.text);
						}
					}
				});
			}
		}
		var userType = mini.get("userType");
    	userType.on("valuechanged", function (e) {
        if(this.getValue()==1){
		   	$('#userStrId').html('人 员 :');
		 }else{
			 $('#userStrId').html('职 位 :');
			 }      
		});   
        var grid1 = mini.get("grid1");
		var grid2 = mini.get("grid2");
	  	grid1.load(null,function()
		 {
		 	var gridData =grid1.getEditData(true);
			for(var i=0;i<gridData.length;i++){
			   var row = gridData[i];
			   grid1.beginEditRow(row);
			}
			});
		grid2.load(null,function()
		 {
		 	var gridData =grid2.getEditData(true);
			for(var i=0;i<gridData.length;i++){
			   var row = gridData[i];
			   grid2.beginEditRow(row);
			}
			});

		function addRow(gid) {
			var regrid = mini.get(gid);
			var row = {};
           regrid.addRow(row);
           regrid.beginEditRow(row);
        }
		 function removeRow(gid) {
			var regrid = mini.get(gid);
            var rows = regrid.getSelecteds();
            if (rows.length > 0) {
                regrid.removeRows(rows, true);
            }
        }
		
      function isrequired(e) {
            if (e.isValid) 
			{
            	var tplType = mini.get('tplStyleFlag').getValue();
				if(tplType==1&&e.value==''){
					e.errorText = "不能为空";
					e.isValid=false;					
				}
	         }
        }
       
      function submitForm() {
            var form = new mini.Form("#form");
			     form.validate();
            if (form.isValid() == false) return false;
            var formData = form.getData();
			var grid1Data =grid1.getEditData(true);
			var grid2Data =grid2.getEditData(true);
            var infoData = mini.encode(formData);
            var projectData = mini.encode(grid1Data);
			var columnsData = mini.encode(grid2Data);
			//alert(infoData);alert(projectData);alert(sizeData);  
			//return false;
            $.ajax({
                url: "?model=administration_appraisal_performance_item&action=editTpl",
                type: "post",
                data: { infoData:infoData,projectData:projectData,columnsData:columnsData},
                success: function (text) {
					if(text==2){
						alert('新增成功！');
						CloseWindow("save");
						//grid.reload();
					}else{
					    alert('新增失败！');	
					}
                }
            });
        }
		function onCloseClick(e){
			  var o= mini.get(e.sender.id);
				o.setValue("");
				o.setText("");	  
		  }
		
		function CloseWindow(action) {
		   if (window.CloseOwnerWindow) return window.CloseOwnerWindow(action);
            else window.close();          
			window.parent.grid.load();  
        }
        function onCancel(e) {
            CloseWindow("cancel");
		}
				
</script>
</body>
</html>