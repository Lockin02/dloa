<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>体检信息登记表</title>
    {#commonInclude#}
</head>
<body>
<div id="billhead" style="width:100%;margin:0;font-size:8">
    <form id="form1" method="post" action="?model=extSevFuns_bodyChk_bodychk&action=submitForm">
        <table class="form_main_table">
            <tr>
                <td colspan="4">
                    <div class="main_head">
                        <span class="main_head_title"> 填写体检信息登记&nbsp;&nbsp;&nbsp;&nbsp;
                            <!--<img src="images/icon/view.gif"><a href="#" title="帮助说明" taget="_blank" id="" onclick="window.open('http://172.16.1.101/book_oa/xiaoshouleihetong.html');">帮助说明</a>-->
                        </span>
                    </div>
                </td>
            </tr>
            <tr>
                <td colspan="6">
                    <fieldset>
                        <legend class="legend" onclick="showAndHide('baseImg','contractinfo')">&nbsp;&nbsp;&nbsp;体&nbsp;检&nbsp;信&nbsp;息&nbsp;&nbsp;&nbsp;</legend>
                        <table width="100%" id="contractinfo" style="border-collapse:collapse;bcontract-collapse:collapse;background-color:#F3F6FA;">
                            <tr>
                                <td class="form_text_left_con">
                                    <span style="color:blue">姓名 :</span>
                                </td>
                                <td class="form_text_right_con">
                                    <input type="text" class="txt" name="bodychk[name]" id="name" value="{name}"/> <font color="red" size="2">*</font>
                                </td>
                                <td class="form_text_left_con">
                                    <span style="color:blue">性别 :</span>
                                </td>
                                <td class="form_text_right_con">
                                    <input type="hidden" class="txt" id="gender" value="{gender}"/>
                                    <select name="bodychk[gender]" id="genderSlt" class="select">
                                        <option value="">.. 请选择您的性别 ..</option>
                                        <option value="男">男</option>
                                        <option value="女">女</option>
                                    </select>
                                    <font color="red" size="2">*</font>
                                </td>
                            </tr>
                            <tr>
                                <td class="form_text_left_con">
                                    <span style="color:blue">身份证 :</span>
                                </td>
                                <td class="form_text_right_con">
                                    <input type="text" class="txt" name="bodychk[identifyCode]" id="identifyCode" value="{identifyCode}"/> <font color="red" size="2">*</font>
                                </td>
                                <td class="form_text_left_con">
                                    <span style="color:blue">联系方式 :</span>
                                </td>
                                <td class="form_text_right_con">
                                    <input type="text" class="txt" name="bodychk[phoneNum]" id="phoneNum" value="{phoneNum}"/> <font color="red" size="2">*</font>
                                </td>
                            </tr>
                            <tr>
                                <td class="form_text_left_con">
                                    <span style="color:blue">省份 :</span>
                                </td>
                                <td class="form_text_right_con">
                                    <select class="select" name="bodychk[provinceCode]" id="provinceCode"></select> <font color="red" size="2">*</font>
                                    <input type="hidden" id="provinceCodeHide" value="{provinceCode}"/>
                                    <input type="hidden" name="bodychk[province]" id="province" value="{province}"/>
                                </td>
                                <td class="form_text_left_con">
                                    <span style="color:blue">城市 :</span>
                                </td>
                                <td class="form_text_right_con">
                                    <input type="hidden" id="cityCodeHide" value="{cityCode}"/>
                                    <input type="hidden" name="bodychk[city]" id="city" value="{city}"/>
                                    <select class="select" name="bodychk[cityCode]" id="cityCode"></select> <font color="red" size="2">*</font>
                                </td>
                            </tr>
                            <tr>
                                <td class="form_text_left_con">
                                    <span style="color:blue">门店 :</span>
                                </td>
                                <td class="form_text_right_con">
                                    <input type="hidden" class="txt" name="bodychk[storeCode]" id="storeCode" value="{storeCode}"/>
                                    <input type="hidden" class="txt" name="bodychk[storeName]" id="storeName" value="{storeName}"/>
                                    <select class="select" id="storeCodeSlt"></select>
                                    <font color="red" size="2">*</font>
                                    &nbsp;&nbsp;&nbsp;<br>
                                    <font id="storeNameTips" color="red" size="2"></font>
                                </td>
                                <td class="form_text_left_con">
                                    附件 :
                                </td>
                                <td class="form_text_right_con">
                                    <a class="newFile" href="?model=extSevFuns_bodyChk_bodychk&amp;action=getFile" taget="_blank" title="点击下载">
                                        美年大健康全国门店分布.xlsx
                                    </a>
                                </td>
                            </tr>
                        </table>
                    </fieldset>
                </td>
            </tr>
            <tr>
                <td colspan="6">
                    <table class="form_main_table">
                        <tr>
                            <td class="txt_btn" colspan="4">
                                <input type="hidden" class="txt" name="bodychk[id]" id="id" value="{id}"/>
                                <input type="hidden" class="txt" name="bodychk[inputUserId]" id="inputUserId" value="{inputUserId}"/>
                                <input type="hidden" class="txt" name="bodychk[inputUserName]" id="inputUserName" value="{inputUserName}"/>
                                <input type="hidden" class="txt" name="bodychk[inputDate]" id="inputDate" value="{inputDate}"/>
                                <input type="hidden" class="txt" name="bodychk[updateDate]" id="updateDate" value="{updateDate}"/>
                                <input type="hidden" class="txt" name="formAct" id="formAct" value="{formAct}"/>
                                <input type="button" class="txt_btn_a" value=" 保  存 " onclick="toSave();"/>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
    </form>
</div>
<script type="text/javascript">
    var provinceUrl = "?model=system_procity_province&action=pageJson&needFlitCode=1"; // 获取省的URL
    var cityUrl = "?model=system_procity_city&action=pageJson"; // 获取市的URL
    var storeUrl = "?model=extSevFuns_bodyChk_bodychk&action=getStores"; // 获取门店的URL

    $(function(){
        // 性别选项初始化
        var gender = $("#gender").val();
        if(gender != ""){
            $("#genderSlt").children().each(function () {
                if($(this).val() == gender){
                    $(this).attr("selected",true);
                }else{
                    $(this).removeAttr("selected");
                }
            })
        }

        //获取省份
        $.ajax({
            type : 'POST',
            url : provinceUrl,
            data:{
                countryId : 1,
                pageSize : 999
            },
            async: false,
            success : function(data){
                var provinceCodeHide = $("#provinceCodeHide").val();
                $('#provinceCode').children().remove("option[value!='']");
                $('#cityCode').children().remove("option[value!='']");
                getProvinces(data,provinceCodeHide);
            }
        });

        // 省的选择改变，获取市
        $('#provinceCode').change(function() {
            var provinceId = $(this).val();
            if(provinceId==""){    //判断是否选择了省份，如果没有选中，刚省份名称为空
                $('#province').val("");
                $('#cityCode').children().remove("option[value!='']");
                $('#city').val("");
            }else{
                $('#province').val($(this).find("option:selected").text());

                $.ajax({
                    type : 'POST',
                    url : cityUrl,
                    data:{
                        provinceId : provinceId,
                        pageSize : 999
                    },
                    async: false,
                    success : function(data){
                        var cityCodeHide = $("#cityCodeHide").val();
                        initCityOpts();
                        getCitys(data,cityCodeHide);
                    }
                });
            }
        });

        initCityOpts();
        initStoreOpts();
    });

    var initCityOpts = function () {
        $('#cityCode').remove();
        $("#city").after('<select class="select" name="bodychk[cityCode]" id="cityCode"></select>');

        // 市的选择改变，获取相关的门店信息
        $('#cityCode').change(function() {
            var cityId = $(this).val();
            if(cityId != ""){
                $("#cityCodeHide").val(cityId);
                $('#city').val($(this).find("option:selected").text());

                var provinceId = $("#provinceCode").find("option:selected").val();

                // console.log("provinceId: "+provinceId+"; cityId: "+cityId);
                $.ajax({
                    type : 'POST',
                    url : storeUrl,
                    data:{
                        cityId : cityId
                    },
                    async: false,
                    success : function(data){
                        data = eval("("+data+")");
                        var storeCode = $("#storeCode").val();
                        getStores(data,storeCode);
                        console.log(data.length);
                        if(data.length <= 0){
                            $("#storeNameTips").text("当前省市没有可选门店，请重新选择。\n【门店信息可参考附件】");
                        }
                    }
                });
            }
        });
    };

    var initStoreOpts = function(){
        $("#storeNameTips").text("");
        $("#storeCodeSlt").remove();
        $("#storeName").after('<select class="select" id="storeCodeSlt"></select>');
        $("#storeCodeSlt").change(function(){
            $("#storeCode").val($(this).val());
            $("#storeName").val($(this).find("option:selected").text());
        });
    };

    /* 获取省的方法 */
    var getProvinces = function(data,sltedProvinceId) {
        var o = eval("(" + data + ")");
        var provinceArr = o.collection;

        // 如果没有默认的值,默认取第一个值
        if(sltedProvinceId == "" || sltedProvinceId == undefined){
            sltedProvinceId = provinceArr[0].id;
        }

        for (var i = 0, l = provinceArr.length; i < l; i++) {
            var province = provinceArr[i];
            var option = (province.id == sltedProvinceId)? $("<option>").val(province.id).html(province.provinceName).attr("selected",true) :
                    $("<option>").val(province.id).html(province.provinceName);
            $('#provinceCode').append(option)
        }
        setTimeout(function(){
            $('#provinceCode').trigger('change');
        },100);
    };

    /* 获取市的方法 */
    function getCitys(data,sltedCityId) {
        var o = eval("(" + data + ")");
        var cityArr = o.collection;
        var totalSize = o.totalSize;

        if(totalSize > 0){
            // 如果没有默认的值,默认取第一个值
            if(sltedCityId == "" || sltedCityId == undefined){
                sltedCityId = cityArr[0].id;
            }

            for (var i = 0, l = cityArr.length; i < l; i++) {
                var city = cityArr[i];
                var option = (city.id == sltedCityId)? $("<option>").val(city.id).html(city.cityName).attr("selected",true) : $("<option>").val(city.id).html(city.cityName);
                $('#cityCode').append(option);
            }
            $('#cityCode').trigger('change');
        }else{
            initStoreOpts();
            $("#cityCodeHide").val("");
            $('#city').val("");
            $('#storeCode').val("");
            $('#storeName').val("");
        }
    };

    function getStores(data,sltedStoreId){
        initStoreOpts();
        $.each(data,function(i,item){
            var option = (item.id == sltedStoreId)? $("<option>").val(item.id).html(item.dataName).attr("selected",true) : $("<option>").val(item.id).html(item.dataName);
            $("#storeCodeSlt").append(option);
        });
        setTimeout(function(){
            $("#storeCodeSlt").trigger('change');
        },100);
    }

    var toSave = function(){
        // 检查姓名
        if($("#name").val() == ""){
            alert("请输入您的姓名。");
            $("#name").focus();
        }
        // 检查姓别
        else if($("#genderSlt").find("option:selected").val() == ""){
            alert("请选择您的性别。");
            $("#genderSlt").focus();
        }
        // 检查身份证
        else if($("#identifyCode").val() == ""){
            alert("请输入您的身份证号。");
            $("#identifyCode").focus();
        }
        // 检查联系方式
        else if($("#phoneNum").val() == ""){
            alert("请输入您的联系方式。");
            $("#phoneNum").focus();
        }
        // 检查省份
        else if($("#provinceCode").find("option:selected").val() == "" || $("#provinceCode").find("option:selected").val() == undefined){
            alert("省份信息有误。");
            $("#provinceCode").focus();
        }
        // 检查城市
        else if($("#cityCode").find("option:selected").val() == "" || $("#cityCode").find("option:selected").val() == undefined){
            alert("城市信息有误。");
            $("#cityCode").focus();
        }
        // 检查门店选项
        else if($("#storeNameTips").text() != ""){
            alert($("#storeNameTips").text());
            $("#storeCodeSlt").focus();
        }else if($("#storeCodeSlt").find("option:selected").val() == ""){
            alert("请选择您要前往的门店【门店信息可参考附件】。");
            $("#storeCodeSlt").focus();
        }else{
            $("#form1").submit();
        }
    }
</script>
</body>
</html>